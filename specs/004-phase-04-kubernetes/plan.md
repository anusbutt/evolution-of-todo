# Implementation Plan: Phase 4 - Local Kubernetes Deployment

**Branch**: `004-phase-04-kubernetes` | **Date**: 2026-01-22 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/004-phase-04-kubernetes/spec.md`

## Summary

Deploy the Todo application (frontend, backend, MCP server) to a local Kubernetes cluster using Minikube and Helm charts. The deployment enables single-command installation, self-healing, scaling, and secure configuration management.

## Technical Context

**Cluster**: Minikube v1.32+ with Docker driver
**Package Manager**: Helm v3.14+
**CLI Tools**: kubectl v1.29+, kubectl-ai, kagent
**Ingress**: NGINX Ingress Controller (Minikube addon)
**Target Platform**: Windows with Docker Desktop
**Resource Limits**: 4 CPU, 8GB RAM (Minikube cluster)
**Constraints**: Local development only, HTTP (no TLS), single-node cluster
**Project Type**: Infrastructure/Deployment (Helm charts)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Gate | Status | Notes |
|------|--------|-------|
| Phase IV Tech Stack | ✅ PASS | Minikube, Helm, kubectl-ai, kagent per constitution |
| Docker Images | ✅ PASS | Using Phase 3 images (todo-frontend, todo-backend, todo-mcp-server) |
| Secrets Management | ✅ PASS | Kubernetes Secrets per constitution |
| Resource Limits | ✅ PASS | 4 CPU, 8GB RAM per constitution |
| Single Command Deploy | ✅ PASS | helm install achieves this |
| Health Checks | ✅ PASS | Liveness and readiness probes configured |

## Project Structure

### Documentation (this feature)

```text
specs/004-phase-04-kubernetes/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Technology decisions
├── data-model.md        # Kubernetes resource models
├── quickstart.md        # Deployment guide
├── contracts/           # Helm chart contracts
│   └── helm-chart-structure.md
├── checklists/
│   └── requirements.md  # Spec validation checklist
└── tasks.md             # Implementation tasks (generated by /sp.tasks)
```

### Source Code (Helm Charts)

```text
deployment/
└── helm/
    └── todo-app/
        ├── Chart.yaml           # Chart metadata
        ├── values.yaml          # Default configuration
        ├── .helmignore          # Ignore patterns
        └── templates/
            ├── _helpers.tpl     # Template helpers
            ├── namespace.yaml   # Namespace: todo-app
            ├── configmap.yaml   # Non-sensitive config
            ├── secret.yaml      # Sensitive credentials
            ├── frontend/
            │   ├── deployment.yaml
            │   └── service.yaml
            ├── backend/
            │   ├── deployment.yaml
            │   └── service.yaml
            ├── mcp-server/
            │   ├── deployment.yaml
            │   └── service.yaml
            └── ingress.yaml     # External routing
```

**Structure Decision**: Helm chart in `deployment/helm/todo-app/` with service-specific subfolders in templates for clear organization.

## Architecture

### High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                         MINIKUBE CLUSTER                            │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                    Namespace: todo-app                        │  │
│  │                                                               │  │
│  │   ┌─────────────────────────────────────────────────────┐    │  │
│  │   │                 NGINX INGRESS                       │    │  │
│  │   │         http://todo.local                           │    │  │
│  │   │   /     → frontend:3000                             │    │  │
│  │   │   /api/* → backend:8000                             │    │  │
│  │   └──────────────────────┬──────────────────────────────┘    │  │
│  │                          │                                    │  │
│  │      ┌───────────────────┼───────────────────┐               │  │
│  │      │                   │                   │               │  │
│  │      ▼                   ▼                   ▼               │  │
│  │  ┌─────────┐        ┌─────────┐        ┌─────────┐          │  │
│  │  │Frontend │        │ Backend │        │   MCP   │          │  │
│  │  │ Service │        │ Service │        │ Service │          │  │
│  │  │ :3000   │        │  :8000  │        │  :5001  │          │  │
│  │  └────┬────┘        └────┬────┘        └────┬────┘          │  │
│  │       │                  │                  │                │  │
│  │  ┌────▼────┐        ┌────▼────┐        ┌────▼────┐          │  │
│  │  │  Pods   │        │  Pods   │        │  Pods   │          │  │
│  │  │ 1-3x    │        │ 1-3x    │        │  1x     │          │  │
│  │  └─────────┘        └─────────┘        └─────────┘          │  │
│  │                                                               │  │
│  │  ┌─────────────────┐    ┌─────────────────┐                  │  │
│  │  │    ConfigMap    │    │     Secret      │                  │  │
│  │  │   todo-config   │    │  todo-secrets   │                  │  │
│  │  └─────────────────┘    └─────────────────┘                  │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    Browser: http://todo.local
```

### Request Flow

```
1. User → http://todo.local
2. Ingress → routes / to frontend:3000
3. Frontend → serves React app
4. Browser → /api/* requests
5. Ingress → routes /api/* to backend:8000
6. Backend → processes request
7. Backend → calls mcp-server:5001 (if AI chat)
8. Response → back through chain
```

### Deployment Flow

```
1. minikube start --driver=docker
2. minikube addons enable ingress
3. minikube image load todo-*:latest
4. helm install todo-app ./deployment/helm/todo-app -n todo-app --create-namespace
5. Add hosts entry: <minikube-ip> todo.local
6. Access: http://todo.local
```

## Key Design Decisions

### 1. Single Helm Chart for All Services

**Decision**: One chart with all three services instead of separate charts per service.

**Rationale**:
- Simpler deployment (one command)
- Shared configuration in one values.yaml
- Atomic deployment/rollback
- Easier for local development

### 2. ClusterIP Services (Internal Only)

**Decision**: All services use ClusterIP type, accessed via Ingress.

**Rationale**:
- Single entry point (Ingress)
- Better security (services not directly exposed)
- Consistent with production patterns

### 3. Local Image Loading

**Decision**: Load images directly into Minikube instead of using registry.

**Rationale**:
- Faster iteration (no push/pull)
- Works offline
- No registry credentials needed

### 4. Rolling Update Strategy

**Decision**: Default rolling update with maxUnavailable: 0.

**Rationale**:
- Zero-downtime upgrades
- Gradual rollout
- Easy rollback if issues

## Resource Allocation

| Service | CPU Request | CPU Limit | Memory Request | Memory Limit | Replicas |
|---------|-------------|-----------|----------------|--------------|----------|
| Frontend | 100m | 500m | 128Mi | 512Mi | 1 |
| Backend | 200m | 1000m | 256Mi | 1Gi | 1 |
| MCP Server | 100m | 500m | 128Mi | 512Mi | 1 |
| **Total** | **400m** | **2000m** | **512Mi** | **2Gi** | **3** |

*Well within 4 CPU, 8GB RAM cluster limits*

## Secrets Required

| Secret Key | Source | Used By |
|------------|--------|---------|
| DATABASE_URL | .env file | Backend |
| JWT_SECRET | .env file | Backend |
| GEMINI_API_KEY | .env file | Backend |

## Complexity Tracking

> No Constitution violations to justify.

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| None | - | - |

## Related Documents

- [spec.md](./spec.md) - Feature requirements
- [research.md](./research.md) - Technology decisions
- [data-model.md](./data-model.md) - Kubernetes resource models
- [quickstart.md](./quickstart.md) - Deployment guide
- [contracts/helm-chart-structure.md](./contracts/helm-chart-structure.md) - Helm chart contract

## Next Steps

Run `/sp.tasks` to generate implementation tasks based on this plan.
